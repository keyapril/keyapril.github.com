<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>转发微博抽奖</title>
    <script src="http://a.tbcdn.cn/s/kissy/1.3.0/seed.js"></script>
    <script src=" http://tjs.sjs.sinajs.cn/open/api/js/wb.js?appkey=2590298054" type="text/javascript" charset="utf-8"></script>

    <script src="http://a.tbcdn.cn/apps/e/brix/1.0/brix.js" bx-config="{componentsPath:'./',importsPath:'./'}"></script>

    <link type="text/css" rel="stylesheet" href="http://a.tbcdn.cn/apps/e/brix/1.0/??brix-min.css,gallery/form/form.css" charset="utf-8">
    <link type="text/css" rel="stylesheet" href="assets/css/luck.css" charset="utf-8">
    <script type="text/javascript">
    var S = KISSY;


    function getRepostUsers(W,users,id,page,count,callback){
        W.parseCMD("/statuses/repost_timeline.json", function(sResult, bStatus){
            if(bStatus&&!S.isEmptyObject(sResult)) {
                var reposts = sResult['reposts'];
                S.each(reposts,function(d,i){
                    var user=d['user'];
                    if(!users[user.id]){
                        users[user.id] = {
                            name :user.name,
                            screen_name:user.screen_name,
                            profile_image_url:user.profile_image_url
                        }
                    }
                });
                if(count*page>=sResult.total_number){
                    callback();
                }
                else{
                    page++;
                    getRepostUsers(W,users,id,page,count,callback);
                }
            }
        },{
            id : id,
            count:count
        },{
            method: 'get'
        });
    }
    KISSY.ready(function(S){
        KISSY.use('node',function(S,Node){
            var btnParseUrl = S.one('#btnParseUrl'),
            txtWeiBoUrl = S.one('#txtWeiBoUrl');
            WB2.anyWhere(function(W){
                W.widget.connectButton({
                    id: "wb_connect_btn",
                    type: '3,2',
                    callback : {
                        login:function(o){
                            btnParseUrl.removeClass('btn-disabled');
                            btnParseUrl.on('click',function(){
                                if(!btnParseUrl.hasClass('btn-disabled')){
                                    btnParseUrl.html('分析中……');
                                    btnParseUrl.addClass('btn-disabled');
                                    var url  = txtWeiBoUrl.val();
                                    var mid = url.substr(url.lastIndexOf('/')+1);
                                    W.parseCMD("/statuses/queryid.json", function(sResult, bStatus){
                                        if(bStatus&&sResult.id!='-1'){
                                            //btnParseUrl.addClass('btn-disabled');
                                            var id = sResult.id;
                                            var users = {};
                                            getRepostUsers(W,users,id,1,200,function(){
                                                btnParseUrl.html('分析');
                                                btnParseUrl.removeClass('btn-disabled');
                                                S.use('components/luck/',function(S,Luck){
                                                    Luck.init(users);
                                                });
                                            });
                                        }
                                        else{
                                            btnParseUrl.html('分析');
                                            btnParseUrl.removeClass('btn-disabled');
                                            alert('没有查询到相关的微博ID')
                                        }
                                        
                                    },{
                                        mid : mid,
                                        type: 1,
                                        isBase62:1
                                    },{
                                        method: 'get'
                                    });
                                }
                            });
                        },
                        logout:function(){
                            btnParseUrl.detach();
                            btnParseUrl.addClass('btn-disabled');
                        }
                    }
                });
            });
        });
    });
    </script>
</head>
<body>
    <div id="wb_connect_btn"></div>
    <div class="header">
        <input id="txtWeiBoUrl" value="http://e.weibo.com/2785042192/zerwgk6Gj" class="input" placeholder="输入要分析的微博地址"><a id="btnParseUrl" class="btn btn-size25 btn-disabled">分析</a>
    </div>
    <button id="go" data-text-start="按空格开始" data-text-stop="按空格停止" data-action="start"></button>
    <div id="container">
        <ul id="balls">
        </ul>
        <ul id="lucky-balls">
        </ul>
    </div>
</body>
</html>